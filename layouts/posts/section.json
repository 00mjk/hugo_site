{{- $pctx := . -}}
{{- if .IsHome -}}
	{{ $pctx = .Site }}
{{- end -}}
{{- $pages := $pctx.RegularPages -}}
{{- $limit := .Site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
	{{- $pages = $pages | first $limit -}}
{{- end -}}
{{ $length := (len $pages) -}}
{
  "version": "https://jsonfeed.org/version/1.1",
  "title": "{{ .Site.Title }}",
  "description": "{{ .Site.Params.Description }}",
  "home_page_url": "{{ .Site.BaseURL }}",
  {{ with .OutputFormats.Get "JSON" -}}
		"feed_url": "{{ .Permalink }}",
  {{ end -}}
  {{ with .Site.LanguageCode -}}
	  "language": "{{ . }}",
  {{ end -}}
  {{ with $.Param "icon" -}}
	  "icon": "{{ . | absURL }}",
  {{ end -}}
  {{ with $.Param "favicon" -}}
	  "favicon": "{{ . | absURL }}",
  {{ end -}}
  {{ with .Site.Author.name -}}
		"authors": [
			{
				"name": "{{ . }}"{{ with $.Site.Author.url }},
				"url": "{{ . }}"{{ end }}{{ with $.Site.Author.avatar }},
				"avatar": "{{ . | absURL }}"{{ end }}
			}
		],
  {{ end -}}
  {{- $JSONutm := "?utm_campaign=JSON&utm_source=JSON&utm_medium=JSON"  -}}
  {{- $PermaWithJSONutm := "" -}}
  "items": [
    {{- range $index, $element := $pages -}}
			{{- $descriptionMD := "[No description]" -}}
			{{- if .Description -}}
				{{- $descriptionMD = print `<p><em>` (.Description | .Page.RenderString) `</em></p>` -}}
			{{- end -}}
			{{- $excerpt := "" -}}
			{{- if .Summary -}}
				{{- $excerpt = (.Summary | .Page.RenderString) -}}
			{{- end -}}
			{{- $getFullFeed := `<hr><p><em>To get postsâ€™ <strong>full</strong> content in your reader, you can subscribe to <a href="https://www.brycewray.com/index.json">this feed</a>.</em></p>` -}}
			{{- $finalHTMLContent := print $descriptionMD `<hr />` $excerpt $getFullFeed -}}
			{
				"title": {{ .Title | jsonify }},
				"date_published": "{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}",
				"id": "{{ .Permalink }}",
				"url": "{{ $PermaWithJSONutm }}",
				{{ with .Params.author -}}
					"authors": [
						{
							"name": "{{ . }}"
						}
					],
				{{ end -}}
				"summary": {{ .Description | jsonify -}},
				"content_html": {{ $finalHTMLContent | jsonify -}}
			}{{ if ne (add $index 1) $length }},{{ end }}
    {{ end -}}
  ]
}
