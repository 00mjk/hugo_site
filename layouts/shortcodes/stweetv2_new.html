{{/*
	=======
	Based on...
	- https://github.com/hugomd/blog/blob/6ad96b24117255c2a9912c566ffd081bd9bbd6f1/layouts/shortcodes/statictweet.html
	- https://hugo.md/post/update-rendering-static-tweets/
	- https://github.com/KyleMit/eleventy-plugin-embed-tweet
	- https://www.stackbit.com/blog/advanced-hugo-templates/
	- https://github.com/astro-community/astro-embed/blob/main/packages/astro-embed-twitter/Tweet.astro
	... and, as of 2022-07-25...
	- https://discourse.gohugo.io/t/error-for-getjson-when-used-with-resources-getresources/39687/4
	- https://discourse.gohugo.io/t/getremote-cannot-pass-headers-bad-request/36877/6
	=======
*/}}

{{/*
	inits --
	see https://www.stackbit.com/blog/advanced-hugo-templates/ (end of "Scratch" section)
*/}}
{{ $text := "" }}
{{ $created_at := "" }}
{{ $profile_image_url := "" }}
{{ $name := "" }}
{{ $username := "" }}
{{ $Bearer_Token := os.Getenv "BEARER_TOKEN" }}

{{- $QT_text := "" -}}
{{- $card := "" -}}
{{- $RT := "" -}}
{{- $RT_text := "" -}}

{{- $user := .Get "user"  -}}
{{- $id := .Get "id" -}}
{{- $urlOembed := printf "https://twitter.com/%v/status/%v" $user $id -}}
{{- $query := querify "url" $urlOembed "dnt" true "omit_script" true -}}
{{- $request := printf "https://publish.twitter.com/oembed?%s" $query -}}

{{- $currentPage := .Page -}}{{/* h/t to DFD on that one */}}

{{ $authHeaders := dict
	"headers" (dict
		"Authorization" (printf "Bearer %s" $Bearer_Token)
	)
}}
{{ $jsonURL1 := "https://api.twitter.com/2/tweets?ids=" }}
{{ $jsonURL2 := "&tweet.fields=attachments,author_id,context_annotations,conversation_id,created_at,entities,geo,id,in_reply_to_user_id,lang,possibly_sensitive,referenced_tweets,reply_settings,source,text,withheld&expansions=attachments.media_keys,attachments.poll_ids,author_id,entities.mentions.username,geo.place_id,in_reply_to_user_id,referenced_tweets.id,referenced_tweets.id.author_id&media.fields=alt_text,duration_ms,height,media_key,preview_image_url,type,url,variants,width&poll.fields=duration_minutes,end_datetime,id,options,voting_status&user.fields=created_at,description,entities,id,location,name,pinned_tweet_id,profile_image_url,protected,url,username,verified,withheld&place.fields=contained_within,country,country_code,full_name,geo,id,name,place_type" }}
{{ $urlToGet := printf "%s%s%s" $jsonURL1 $id $jsonURL2 }}

{{ with resources.GetRemote $urlToGet $authHeaders }}
	{{ $json := unmarshal .Content }}
	{{- $jsonOembed := resources.GetRemote $request -}}
	{{- $jsonOembed = $jsonOembed | transform.Unmarshal -}}
	{{- $jsonOHTML := $jsonOembed.html -}}

	{{ with $json }}
		{{ range $json.data }}
			{{ $data := . }}
			{{ $created_at = $data.created_at }}
			{{ $text = $data.text }}
			{{ with $data.entities }}
				{{ $entities := . }}
				{{ range $entities.mentions }}
					{{ $mentions := . }}
					{{ $text = replace $text (printf "@%s" $mentions.username) (printf "<a href='https://twitter.com/%s' rel='noopener' class='twitterExt'>@%s</a>" $mentions.username $mentions.username) }}
				{{ end }}
				{{ range $entities.hashtags }}
					{{ $hashtags := . }}
					{{ $text = replace $text (printf "#%s" $hashtags.tag) (printf "<a href='https://twitter.com/hashtag/%s?src=hash&ref_src=twsrc' rel='noopener' class='twitterExt'>#%s</a>" $hashtags.tag $hashtags.tag) }}
				{{ end }}
				{{ range $entities.urls }}
					{{ $urls := . }}
					{{ if not $urls.images }}
						{{ if not $urls.unwound_url }}
							{{ if in $urls.display_url "buff.ly" }}
								{{ $text = replace $text $urls.url (printf "<a href='%s' rel='noopener' class='twitterExt'>%s</a>" $urls.url $urls.display_url) }}
							{{ else }}
								{{ $text = replace $text $urls.url "" }}
							{{ end }}
						{{ else }}
							{{ $text = replace $text $urls.url (printf "<a href='%s' rel='noopener' class='twitterExt'>%s</a>" $urls.url $urls.display_url) }}
						{{ end }}
					{{ else }}
						{{ $text = replace $text $urls.url (printf "<a href='%s' rel='noopener' class='twitterExt'>%s</a>" $urls.url $urls.display_url) }}
					{{ end }}
				{{ end }}
			{{ end }}
			{{ if isset $data "in_reply_to_user_id" }}
				{{ $userIdToMatch := $data.in_reply_to_user_id }}
				{{ $RT_text = "Replying to" }}
				{{/*
					now, loop through $json.includes.users
					and find the `id` that matches $userIdToMatch,
					then identify it as $userRepliedTo or similar
				*/}}
				{{ range $json.includes.users }}
					{{ $usersSearched := . }}
					{{ if eq $usersSearched.id $userIdToMatch }}
						{{ $RT_text = print $RT_text " " (print "<a href='https://twitter.com/" $usersSearched.username "' rel='noopener' class='twitterExt'>@" $usersSearched.username "</a>") }}
						{{ $RT_text = $RT_text | $currentPage.RenderString }}
					{{ end }}
				{{ end }}
			{{ end }}
		{{ end }}
		{{ with $json.includes }}
			{{ $includes := . }}
			{{ with $includes.users }}
				{{ $author := index . 0 }}
				{{/*
					that first item in `$json.includes.users` will be the tweet's author; see:
					https://linvi.github.io/tweetinvi/dist/twitter-api-v2/basics.html#expansion-and-responses
				*/}}
				{{ $profile_image_url = $author.profile_image_url }}
				{{ $name = $author.name }}
				{{ $username = $author.username }}
			{{ end }}
		{{ end }}
	{{ end }}


	{{- $jsonOHTML = $jsonOHTML | replaceRE `<blockquote class="twitter-tweet" data-dnt="true"><p lang="en" dir="ltr">` `` -}}
	{{- $jsonOHTML = $jsonOHTML | replaceRE `</p>.*` `` -}}

	{{- $jsonOHTML = replace $jsonOHTML "!<a" "! <a" -}}
	{{- $jsonOHTML = replace $jsonOHTML ".<a" ". <a" -}}
	{{- $jsonOHTML = replace $jsonOHTML ">https://t.co/QPSmjqXwft" ">brycewray.com" -}}
	{{- $jsonOHTML = replace $jsonOHTML ">https://t.co/Oeoaacz8z8" ">brycewray.com/posts/2019/02/â€¦" -}}
	{{- $jsonOHTML = replace $jsonOHTML ">https://t.co/ErdQPfeAps" ">brycewray.com/posts/2019/06/â€¦" -}}
	{{- $jsonOHTML = replace $jsonOHTML ">https://t.co/RXBMHpqW3e" ">netlify.com/products/analytics/" -}}
	{{- $jsonOHTML = replace $jsonOHTML "IÂ’â€™ll" "Iâ€™ll" -}}
	{{- $jsonOHTML = replace $jsonOHTML "ðŸ˜„<a" "ðŸ˜„ <a" -}}
	{{- $jsonOHTML = replace $jsonOHTML ">https://t.co/wB96VIVOLn" ">brycewray.com" -}}
	{{- $jsonOHTML = $jsonOHTML | replaceRE `<a href="https://t.co/x6y4ksDwrt">https://t.co/x6y4ksDwrt</a>` `` -}}
	{{- $jsonOHTML = replace $jsonOHTML "users<br>(embedded" "users (embedded" -}}
	{{- $jsonOHTML = $jsonOHTML | replaceRE `<a href="https://t.co/tryfucEzv5">pic.twitter.com/tryfucEzv5</a>` `` -}}
	{{- $jsonOHTML = $jsonOHTML | replaceRE `<a href="https://t.co/Dit0BhDVLg">pic.twitter.com/Dit0BhDVLg</a>` `` -}}
	{{- $jsonOHTML = $jsonOHTML | replaceRE `<a href="https://t.co/jsuCgadKmE">https://t.co/jsuCgadKmE</a>` `` -}}
	{{- $jsonOHTML = replace $jsonOHTML ":<a" ": <a" -}}
	{{- $jsonOHTML = replace $jsonOHTML ">https://t.co/M2dJYnyAhc" ">11ty.dev/docs/languagesâ€¦" -}}
	{{- $jsonOHTML = $jsonOHTML | replaceRE `<a href="https://t.co/GTtPejFT8N">pic.twitter.com/GTtPejFT8N</a>` `` -}}
	{{- $jsonOHTML = replace $jsonOHTML ">https://t.co/99QL57gPPA" ">brycewray.com" -}}
	{{- $jsonOHTML = $jsonOHTML | replaceRE `<a href="https://t.co/99QL57yqH8">https://t.co/99QL57yqH8</a>` `` -}}
	{{- $jsonOHTML = replace $jsonOHTML ">https://t.co/cBGolS1bct" ">hugoconf.io" -}}
	{{- $jsonOHTML = $jsonOHTML | replaceRE `<a href="https://t.co/6vZvoEoAZU">https://t.co/6vZvoEoAZU</a>` `` -}}
	{{- $jsonOHTML = $jsonOHTML | replaceRE `<a href="https://t.co/Ode2sKCtpG">https://t.co/Ode2sKCtpG</a>` `` -}}
	{{- $jsonOHTML = replace $jsonOHTML ">https://t.co/LOmOSrG28e" ">github.com/giscus/giscus/..." -}}

	{{- $tweetLink := print "https://twitter.com/" $username "/status/" $id -}}


	<blockquote class="tweet-card" cite="{{ $tweetLink }}">
		<div class="tweet-header">
			<a class="tweet-profile twitterExt" href="https://twitter.com/{{ $username }}" rel="noopener">
				<img src="{{ $profile_image_url }}" alt="Twitter avatar for @{{ $username }}" loading="lazy" />
			</a>
			<div class="tweet-author">
				<a class="tweet-author-name twitterExt" href="https://twitter.com/{{ $username}}" rel="noopener">{{ $name }}</a>
				<a class="tweet-author-handle twitterExt" href="https://twitter.com/{{ $username }}" rel="noopener">@{{ $username }}</a>
			</div>
		</div>
		{{- if ne $RT_text "" -}}
			<p class="pokey tweet-reply-to">
				{{- $RT_text -}}
			</p>
		{{- end }}
		{{ $jsonOHTML | safeHTML }}
		{{ $imageCount := 1}}
		{{ with $json }}
			{{ with $json.includes }}
				{{ $includes := . }}
				{{ if $includes.media }}
					{{ $imageCount = len $includes.media }}
				{{ end }}
				<div class="tweet-img-grid-{{ $imageCount }}">
				{{ range $includes.media }}
					{{ if not (eq .type "animated_gif" ) }}
						<img src="{{ .url }}" alt="Image {{ .media_key }} from Twitter" class="tweet-media-img" loading="lazy" />
					{{ end }}
				{{ end }}
				</div>
			{{ end }}
		{{ end }}
		<div class="tweet-footer">
			<a href='https://twitter.com/{{ $username }}/status/{{ $id }}' class='tweet-date twitterExt' rel='noopener'>{{ dateFormat "3:04 PM â€¢ January 2, 2006" $created_at }}</a>&nbsp;<span class="legal">(UTC)</span>
		</div>
	</blockquote>
{{ end }}

